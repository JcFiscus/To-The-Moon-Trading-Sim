<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>To The Moon â€” Trading Sim (v0.1)</title>
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="stylesheet" href="./css/upgrades.css">
</head>
<body>
  <noscript>This game needs JavaScript. Which, yes, is still a thing in 2025.</noscript>

  <header class="app-header">
    <div class="app-header__intro">
      <h1 class="app-header__title">ðŸš€ To The Moon â€” Trading Sim</h1>
      <p class="app-header__tagline">Prototype command deck. Built for fast iteration and questionable decisions.</p>
    </div>
    <div class="hud" data-module="hud" role="status" aria-live="polite">
      <div class="hud__metrics">
        <div class="hud-metric">
          <span class="hud-metric__label">Day</span>
          <strong class="hud-metric__value" data-field="day">1</strong>
        </div>
        <div class="hud-metric">
          <span class="hud-metric__label">Cash</span>
          <strong class="hud-metric__value" data-field="cash">$10,000.00</strong>
        </div>
        <div class="hud-metric">
          <span class="hud-metric__label">Equity</span>
          <strong class="hud-metric__value" data-field="equity">$10,000.00</strong>
        </div>
        <div class="hud-metric">
          <span class="hud-metric__label">P&amp;L</span>
          <strong class="hud-metric__value hud-metric__value--pl" data-field="pl">$0.00</strong>
        </div>
      </div>
      <div class="hud__timer" data-field="day-timer" data-state="paused" role="group" aria-label="Trading day countdown">
        <div class="hud-timer__header">
          <span class="hud-timer__label">Day Timer</span>
          <span class="hud-timer__value" data-element="timer-label">Paused</span>
        </div>
        <div class="hud-timer__bar" data-element="timer-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="100" aria-valuetext="Market paused">
          <div class="hud-timer__progress" data-element="timer-progress" style="width: 100%;"></div>
        </div>
      </div>
      <div class="hud__actions">
        <button class="btn btn-primary" data-action="toggle-run" data-tooltip="Start or pause the market clock">Start</button>
        <button class="btn" data-action="end-day" data-tooltip="Advance to the next trading day">End Day</button>
        <button class="btn btn-danger" data-action="reset-run" data-tooltip="Retire this run and cash out">Reset</button>
        <button class="btn" data-action="open-meta" data-tooltip="Open Mission Control to spend research credits">Mission Control</button>
      </div>
      <span class="hud__hint">Autosaves locally. No crypto wallet required. You're welcome.</span>
    </div>
  </header>

  <main id="dashboard" class="app-grid">
    <section class="panel panel--market" data-module="market">
      <header class="panel__header">
        <div>
          <h2>Market Radar</h2>
          <p class="panel__subtitle">Live tickers, quick actions, and the pulse of chaos.</p>
        </div>
        <div class="qty-picker" data-tooltip="Default quantity used for quick trades from the market table">
          <label for="qty-global">Default Qty</label>
          <input id="qty-global" data-element="default-qty" type="number" min="1" step="1" value="10" />
        </div>
      </header>
      <div class="table-wrap">
        <table class="table" aria-label="Market table">
          <thead>
            <tr>
              <th scope="col">Ticker</th>
              <th scope="col">Name</th>
              <th scope="col" class="num">Price</th>
              <th scope="col" class="num">Î”%</th>
              <th scope="col" class="num">Position</th>
              <th scope="col" class="num">Unrl. P&amp;L</th>
              <th scope="col" class="num">Actions</th>
            </tr>
          </thead>
          <tbody data-region="market-body"></tbody>
        </table>
        <div class="table-empty" data-element="market-empty">No assets yet. Launch a run to load the market.</div>
      </div>
    </section>

    <section class="panel panel--detail" data-module="asset-detail">
      <header class="panel__header">
        <div>
          <h2 data-element="detail-title">Asset Details</h2>
          <p class="panel__subtitle">Inspect drivers and positions before you pull the trigger.</p>
        </div>
        <div class="detail-reason" data-element="detail-reason" aria-live="polite">Select an asset to inspect market context.</div>
      </header>
      <div class="detail-card">
        <dl class="detail-grid">
          <div class="detail-line">
            <dt>Asset</dt>
            <dd data-element="detail-asset">â€”</dd>
          </div>
          <div class="detail-line">
            <dt>Price</dt>
            <dd data-element="detail-price">â€”</dd>
          </div>
          <div class="detail-line">
            <dt>Your Position</dt>
            <dd data-element="detail-position">â€”</dd>
          </div>
        </dl>

        <div class="detail-panels">
          <section class="effects" aria-label="Active effects">
            <div class="effects__title">Active Effects</div>
            <ul class="effects__list" data-element="effects-list"></ul>
          </section>

          <section class="effects effects--drivers" aria-label="Price drivers">
            <div class="effects__title">Price Drivers</div>
            <ul class="effects__list" data-element="drivers-list"></ul>
          </section>
        </div>

        <canvas data-element="chart" width="560" height="240" aria-label="Price chart"></canvas>

        <section class="trade-shell" data-module="trade-controls">
          <header class="trade-shell__header">
            <h3>Trade Controls</h3>
            <span class="trade-shell__asset" data-element="trade-asset">Select an asset from the market table.</span>
          </header>
          <div class="trade-controls">
            <label for="trade-qty">Qty</label>
            <input id="trade-qty" data-element="trade-qty" type="number" min="1" step="1" value="10" />
            <button class="btn btn-primary" data-action="trade-buy" data-tooltip="Submit a buy order for the selected asset">Buy</button>
            <button class="btn" data-action="trade-sell" data-tooltip="Submit a sell order for the selected asset">Sell</button>
          </div>
          <div class="trade-confirm is-hidden" data-element="trade-message" role="status" aria-live="polite"></div>
        </section>
      </div>
    </section>

    <section class="panel panel--events" data-module="events">
      <header class="panel__header">
        <div>
          <h2>Situation Room</h2>
          <p class="panel__subtitle">Story events with lasting market impact.</p>
        </div>
      </header>
      <div class="event-queue" data-region="event-list">
        <div class="event-empty" data-element="events-empty"><span class="meta">No active scenarios.</span></div>
      </div>
    </section>

    <section class="panel panel--feed" data-module="news">
      <header class="panel__header">
        <div>
          <h2>News Feed</h2>
          <p class="panel__subtitle">Events apply temporary market effects. Because vibes move prices.</p>
        </div>
      </header>
      <ul class="feed" data-region="news-list" aria-live="polite"></ul>
      <div class="feed-empty" data-element="news-empty">Waiting for market chatterâ€¦</div>
    </section>

    <aside class="panel panel--upgrades" data-module="upgrade-shop">
      <header class="panel__header">
        <div>
          <h2>Upgrade Hangar</h2>
          <p class="panel__subtitle">Invest in tech that rewrites the rules mid-run.</p>
        </div>
      </header>
      <div id="insider-banner" class="insider-banner hidden" role="status" aria-live="polite"></div>
      <div class="upgrade-status is-hidden" data-element="upgrade-status" aria-live="polite"></div>
      <div class="upgrade-grid" data-region="upgrade-list"></div>
    </aside>

    <aside class="panel panel--meta-preview">
      <header class="panel__header">
        <div>
          <h2>Mission Brief</h2>
          <p class="panel__subtitle">Space reserved for tutorials, goals, or meta progression.</p>
        </div>
      </header>
      <div class="meta-preview">
        <p>Coming soon: guideposts for your next moonshot. Feature packs can mount here without reworking the dashboard layout.</p>
      </div>
    </aside>
  </main>

  <div id="meta-layer" class="meta-layer" aria-hidden="true">
    <div class="meta-dialog" role="dialog" aria-modal="true" aria-labelledby="meta-title">
      <button id="btn-meta-close" class="meta-close" aria-label="Close mission control">Ã—</button>
      <header class="meta-dialog__header">
        <h2 id="meta-title">Mission Control</h2>
        <div class="meta-balance">Research Credits: <span id="meta-balance">0</span></div>
      </header>
      <div class="meta-dialog__body">
        <section class="meta-summary" id="meta-summary"></section>
        <section class="meta-history" id="meta-history"></section>
        <section class="meta-upgrades" id="meta-upgrades"></section>
      </div>
      <footer class="meta-dialog__footer">
        <button id="btn-meta-start" class="btn btn-primary">Launch New Run</button>
        <button id="btn-meta-resume" class="btn">Resume Run</button>
      </footer>
    </div>
  </div>

  <footer class="app-footer">
    <p>Prototype v0.1. Prices are simulated. If you lose money here, thatâ€™s on your decision-making, not the physics engine.</p>
  </footer>

  <script type="module" src="./js/main.js"></script>
  <script type="module" src="./js/core/upgrades.js"></script>
  <script type="module" src="./js/core/margin.js"></script>
  <script type="module" src="./js/core/insider.js"></script>
  <script type="module" src="./js/ui/upgrades.js"></script>
  <script type="module" src="./js/ui/insiderBanner.js"></script>
  <script>window.__TTM_NO_AUTO__ = true;</script>
  <script type="module" src="./js/featurePack.js"></script>
  <script src="js/upgrades.js"></script>

  <script type="module">
    import { init } from "./js/featurePack.js";

    let started = false;
    const tryStart = (game) => {
      if (started) return true;
      if (!game || typeof game.getState !== "function") return false;

      const getPortfolioValue = (state) => {
        if (typeof game.portfolioValue === "function") {
          return game.portfolioValue(state);
        }
        const snapshot = state ?? game.getState();
        if (!snapshot || !Array.isArray(snapshot.assets)) return 0;
        return snapshot.assets.reduce((sum, asset) => {
          const pos = snapshot.positions?.[asset.id];
          return sum + (pos ? pos.qty * asset.price : 0);
        }, 0);
      };

      const getAssetIds = (state) => {
        const snapshot = state ?? game.getState();
        if (!snapshot || !Array.isArray(snapshot.assets)) return [];
        return snapshot.assets.map((asset) => asset.id);
      };

      init(game, {
        getPortfolioValue,
        getAssetIds
      });

      started = true;
      return true;
    };

    if (!tryStart(window.ttmGame)) {
      window.addEventListener(
        "ttm:gameReady",
        (event) => {
          tryStart(event.detail || window.ttmGame);
        },
        { once: true }
      );
    }
  </script>

</body>
</html>
